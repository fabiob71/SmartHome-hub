<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SmartHome Hub – Fabio</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
<style>
  :root {
    --bg: #121417;
    --bg-alt: #1e222a;
    --card-bg: #252a38;
    --txt-primary: #e8ecf1;
    --txt-secondary: #8a94a7;
    --accent: #6ae3ff;
    --accent2: #7bffb7;
    --border: #303752;
    --shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    --red: #ff6b6b;
    --green: #38d39f;
    --amber: #ffc857;
  }

  * {
    box-sizing: border-box;
  }
  body {
    margin: 0;
    font-family: 'Roboto', sans-serif;
    background: var(--bg);
    color: var(--txt-primary);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }
  header {
    background: var(--bg-alt);
    border-bottom: 1px solid var(--border);
    padding: 0 24px;
    height: 56px;
    display: flex;
    align-items: center;
    gap: 12px;
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .logo {
    font-weight: 700;
    font-size: 1.3rem;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .logo .pill {
    background: var(--accent);
    color: var(--bg);
    font-size: 0.75rem;
    padding: 2px 8px;
    border-radius: 12px;
    font-weight: 700;
  }
  nav {
    margin-left: auto;
    display: flex;
    gap: 16px;
  }
  nav button {
    background: transparent;
    border: none;
    color: var(--txt-secondary);
    font-weight: 500;
    font-size: 1rem;
    padding: 8px 12px;
    border-radius: 10px;
    cursor: pointer;
    transition: background-color 0.3s ease, color 0.3s ease;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  nav button.active,
  nav button:hover {
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    color: var(--bg);
  }
  main {
    flex-grow: 1;
    max-width: 1100px;
    margin: 24px auto;
    padding: 0 16px 50px;
    width: 100%;
  }
  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(280px,1fr));
    gap: 20px;
  }
  .card {
    background: var(--card-bg);
    border-radius: 16px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .card > h3 {
    margin: 0;
    padding: 18px 24px;
    border-bottom: 1px solid var(--border);
    font-weight: 700;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .card > h3 .material-icons {
    color: var(--accent);
    font-size: 24px;
  }
  .content {
    padding: 16px 24px;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .row {
    background: var(--bg-alt);
    padding: 12px 16px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: inset 0 0 4px rgba(0,0,0,0.2);
    border: 1px solid var(--border);
  }
  .row:hover {
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    color: var(--bg);
  }
  .row .meta {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 0.9rem;
  }
  .toggle {
    -webkit-appearance: none;
    appearance: none;
    width: 48px;
    height: 28px;
    background: #394155;
    border-radius: 999px;
    position: relative;
    cursor: pointer;
    outline: none;
    border: 1px solid var(--border);
    transition: background-color 0.3s ease;
  }
  .toggle:checked {
    background: linear-gradient(135deg, var(--accent), var(--accent2));
  }
  .toggle:before {
    content: "";
    position: absolute;
    top: 3px;
    left: 3px;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: #fff;
    transition: transform 0.3s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
  .toggle:checked:before {
    transform: translateX(20px);
  }
  .btn {
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border: 0;
    color: var(--bg);
    font-weight: 700;
    padding: 10px 16px;
    border-radius: 12px;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  .btn:hover {
    background: linear-gradient(135deg, var(--accent2), var(--accent));
  }
  .pill {
    font-size: 12px;
    border: 1px solid var(--border);
    padding: 4px 10px;
    border-radius: 999px;
    color: var(--txt-secondary);
    background: var(--bg-alt);
    user-select: none;
  }
  .muted {
    color: var(--txt-secondary);
  }
  .hint {
    font-size: 13px;
    color: var(--txt-secondary);
  }
  /* Floorplan */
  .plan-wrap {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    justify-content: center;
  }
  .canvas {
    background: var(--bg-alt);
    border: 2px dashed var(--border);
    border-radius: 16px;
    position: relative;
    min-height: 320px;
    max-width: 100%;
    flex: 1 1 320px;
    overflow: hidden;
  }
  .canvas img {
    width: 100%;
    height: auto;
    display: block;
    opacity: 0.95;
    user-select: none;
    pointer-events: none;
  }
  .pin {
    position: absolute;
    transform: translate(-50%, -100%);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    cursor: grab;
    user-select: none;
    transition: filter 0.3s ease, opacity 0.3s ease;
  }
  .pin i {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--amber), var(--accent));
    box-shadow: 0 3px 14px rgba(0,0,0,0.5);
    display: inline-block;
  }
  .pin label {
    font-size: 13px;
    background: var(--bg-alt);
    border: 1px solid var(--border);
    padding: 4px 8px;
    border-radius: 8px;
    white-space: nowrap;
  }
  .pin.off i {
    filter: grayscale(1);
    opacity: 0.5;
  }
  /* Responsive */
  @media (max-width: 650px) {
    nav {
      gap: 8px;
    }
    nav button {
      font-size: 0.9rem;
      padding: 6px 10px;
    }
    main {
      margin: 16px 12px;
      padding-bottom: 30px;
    }
  }
</style>
</head>
<body>
<header>
  <div class="logo">
    <span class="material-icons" style="font-size:28px;color:var(--accent)">home</span>
    SmartHome Hub <span class="pill">MVP</span>
  </div>
  <nav id="nav"></nav>
</header>
<main id="view"></main>

<script>
/* ===========================
   SmartHome Hub – MVP Frontend
   State saved in localStorage
   Devices, Rooms, Floorplan, Automations
=========================== */

const TABS = [
  {id:"dash", label:"Dashboard", icon:"dashboard"},
  {id:"devices", label:"Dispositivi", icon:"devices"},
  {id:"floor", label:"Planimetria", icon:"map"},
  {id:"auto", label:"Automazioni", icon:"settings_remote"},
  {id:"backup", label:"Backup", icon:"backup"},
  {id:"settings", label:"Impostazioni", icon:"settings"},
];

const $ = (sel, el=document) => el.querySelector(sel);
const $$ = (sel, el=document) => [...el.querySelectorAll(sel)];
const bus = new EventTarget();

const state = load() || {
  devices: [],        // {id,name,type,room,on,meta:{}, x,y}
  rooms: ["Ingresso","Salone","Cucina","Camera","Bagno"],
  floorplan: {src:"", pins:{}}, // pins by device id: {x,y}
  automations: [],    // {id,name,if:{deviceId,prop,op,value}, then:{deviceId,action}}
  prefs: {theme:"dark", units:"metric"},
  createdAt: Date.now()
};

function load(){ try { return JSON.parse(localStorage.getItem("fabio_hub_v2")); } catch(e){ return null; } }
function save(){ localStorage.setItem("fabio_hub_v2", JSON.stringify(state)); }

function uid(){ return Math.random().toString(36).slice(2,9); }
function setTab(id){ location.hash = id; render(); }
function activeTab(){ return location.hash?.slice(1) || "dash"; }

function renderNav(){
  const nav = $("#nav");
  nav.innerHTML = "";
  TABS.forEach(t=>{
    const b=document.createElement("button");
    b.title = t.label;
    b.innerHTML = `<span class="material-icons">${t.icon}</span> ${t.label}`;
    b.className = activeTab()===t.id ? "active" : "";
    b.onclick = () => setTab(t.id);
    nav.appendChild(b);
  });
}

/* ------- VIEWS -------- */
function render(){
  renderNav();
  const v = $("#view");
  const tab = activeTab();

  if(tab==="dash") renderDashboard(v);
  else if(tab==="devices") renderDevices(v);
  else if(tab==="floor") renderFloorplan(v);
  else if(tab==="auto") renderAutomations(v);
  else if(tab==="backup") renderBackup(v);
  else if(tab==="settings") renderSettings(v);
  else v.textContent = "Tab non trovata";
}

/* ----- Dashboard ----- */
function renderDashboard(v){
  v.innerHTML = "";
  const card = document.createElement("section");
  card.className = "card";
  card.innerHTML = `<h3><span class="material-icons">dashboard</span> Dashboard</h3>`;
  const content = document.createElement("div");
  content.className = "content";

  // Mostra numero dispositivi e stanze
  content.innerHTML = `
    <p>Dispositivi totali: <strong>${state.devices.length}</strong></p>
    <p>Stanze configurate: <strong>${state.rooms.length}</strong></p>
    <p>Automazioni attive: <strong>${state.automations.length}</strong></p>
    <p>Ultimo backup: <strong>${localStorage.getItem('fabio_hub_backup_date') || 'Mai'}</strong></p>
  `;

  card.appendChild(content);
  v.appendChild(card);
}

/* ----- Devices ----- */
function renderDevices(v){
  v.innerHTML = "";
  const card = document.createElement("section");
  card.className = "card";
  card.innerHTML = `<h3><span class="material-icons">devices</span> Dispositivi</h3>`;

  const content = document.createElement("div");
  content.className = "content";

  if(state.devices.length === 0){
    content.innerHTML = `<p class="muted">Nessun dispositivo aggiunto. Aggiungine uno nuovo!</p>`;
  } else {
    const list = document.createElement("div");
    list.className = "list";

    state.devices.forEach(d=>{
      const row = document.createElement("div");
      row.className = "row";
      const isOn = d.on ? "checked" : "";
      row.innerHTML = `
        <div>
          <strong>${d.name}</strong> <span class="pill">${d.type}</span> <span class="muted">(${d.room || "Nessuna stanza"})</span>
        </div>
        <input type="checkbox" class="toggle" data-id="${d.id}" ${isOn} aria-label="Accendi o spegni dispositivo" />
      `;
      list.appendChild(row);
    });
    content.appendChild(list);
  }

  // Aggiungi bottone aggiunta dispositivo
  const addBtn = document.createElement("button");
  addBtn.className = "btn";
  addBtn.textContent = "Aggiungi dispositivo";
  addBtn.onclick = () => addDevice();
  content.appendChild(addBtn);

  card.appendChild(content);
  v.appendChild(card);

  // Eventi toggle
  $$(".toggle").forEach(toggle=>{
    toggle.onchange = e => {
      const id = e.target.dataset.id;
      const device = state.devices.find(d=>d.id===id);
      if(device){
        device.on = e.target.checked;
        save();
        bus.dispatchEvent(new CustomEvent("device-toggled", {detail: device}));
      }
    }
  });
}

function addDevice(){
  const name = prompt("Nome dispositivo:");
  if(!name) return alert("Nome obbligatorio");
  const type = prompt("Tipo dispositivo (es. lampada, sensore):") || "generico";
  const room = prompt(`Stanza (scegli tra: ${state.rooms.join(", ")}):`) || "";
  const newDevice = {id: uid(), name, type, room, on:false, meta:{}, x:50, y:50};
  state.devices.push(newDevice);
  save();
  render();
}

/* ----- Floorplan ----- */
function renderFloorplan(v){
  v.innerHTML = "";
  const card = document.createElement("section");
  card.className = "card";
  card.innerHTML = `<h3><span class="material-icons">map</span> Planimetria</h3>`;

  const content = document.createElement("div");
  content.className = "content";

  const wrapper = document.createElement("div");
  wrapper.className = "plan-wrap";

  // Immagine planimetria con pins
  const canvas = document.createElement("div");
  canvas.className = "canvas";

  if(state.floorplan.src){
    const img = document.createElement("img");
    img.src = state.floorplan.src;
    canvas.appendChild(img);
  } else {
    canvas.innerHTML = `<p class="muted" style="padding:16px;">Nessuna planimetria caricata.</p>`;
  }

  // Pins dispositivi posizionati
  state.devices.forEach(d=>{
    if(d.x !== undefined && d.y !== undefined && state.floorplan.src){
      const pin = document.createElement("div");
      pin.className = "pin" + (d.on ? "" : " off");
      pin.style.left = d.x + "%";
      pin.style.top = d.y + "%";
      pin.title = d.name;
      pin.innerHTML = `<i class="material-icons">place</i><label>${d.name}</label>`;

      // Drag & drop semplice
      pin.onpointerdown = e => {
        e.preventDefault();
        const startX = e.clientX;
        const startY = e.clientY;
        const rect = canvas.getBoundingClientRect();
        function onMove(ev){
          let dx = ev.clientX - startX;
          let dy = ev.clientY - startY;
          let newX = ((pin.offsetLeft + dx) / rect.width) * 100;
          let newY = ((pin.offsetTop + dy) / rect.height) * 100;
          newX = Math.min(100, Math.max(0, newX));
          newY = Math.min(100, Math.max(0, newY));
          pin.style.left = newX + "%";
          pin.style.top = newY + "%";
        }
        function onUp(ev){
          document.removeEventListener("pointermove", onMove);
          document.removeEventListener("pointerup", onUp);
          // Salvo posizione in device
          d.x = parseFloat(pin.style.left);
          d.y = parseFloat(pin.style.top);
          save();
        }
        document.addEventListener("pointermove", onMove);
        document.addEventListener("pointerup", onUp);
      }

      canvas.appendChild(pin);
    }
  });

  wrapper.appendChild(canvas);

  // Upload planimetria
  const inputFile = document.createElement("input");
  inputFile.type = "file";
  inputFile.accept = "image/*";
  inputFile.style.marginTop = "16px";
  inputFile.onchange = e => {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      state.floorplan.src = ev.target.result;
      save();
      render();
    };
    reader.readAsDataURL(file);
  };
  content.appendChild(wrapper);
  content.appendChild(inputFile);

  card.appendChild(content);
  v.appendChild(card);
}

/* ----- Automations ----- */
function renderAutomations(v){
  v.innerHTML = "";
  const card = document.createElement("section");
  card.className = "card";
  card.innerHTML = `<h3><span class="material-icons">settings_remote</span> Automazioni</h3>`;
  const content = document.createElement("div");
  content.className = "content";

  if(state.automations.length === 0){
    content.innerHTML = `<p class="muted">Nessuna automazione configurata. Creane una nuova!</p>`;
  } else {
    const list = document.createElement("div");
    list.className = "list";
    state.automations.forEach(a=>{
      const row = document.createElement("div");
      row.className = "row";
      row.textContent = `${a.name} - IF ${a.if.deviceId} ${a.if.prop} ${a.if.op} ${a.if.value} THEN ${a.then.deviceId} ${a.then.action}`;
      list.appendChild(row);
    });
    content.appendChild(list);
  }

  const addBtn = document.createElement("button");
  addBtn.className = "btn";
  addBtn.textContent = "Aggiungi automazione";
  addBtn.onclick = () => addAutomation();
  content.appendChild(addBtn);

  card.appendChild(content);
  v.appendChild(card);
}

function addAutomation(){
  const name = prompt("Nome automazione:");
  if(!name) return alert("Nome obbligatorio");

  if(state.devices.length < 2) return alert("Aggiungi almeno due dispositivi prima!");

  // Semplice creazione via prompt
  const deviceIf = prompt("IF: id dispositivo trigger:");
  const prop = prompt("Proprietà (es: on):");
  const op = prompt("Operatore (es: ==):");
  const value = prompt("Valore (es: true):");

  const deviceThen = prompt("THEN: id dispositivo azione:");
  const action = prompt("Azione (es: toggle):");

  if(!deviceIf || !prop || !op || !deviceThen || !action) return alert("Dati incompleti");

  const auto = {
    id: uid(),
    name,
    if: {deviceId: deviceIf, prop, op, value},
    then: {deviceId: deviceThen, action}
  };
  state.automations.push(auto);
  save();
  render();
}

/* ----- Backup ----- */
function renderBackup(v){
  v.innerHTML = "";
  const card = document.createElement("section");
  card.className = "card";
  card.innerHTML = `<h3><span class="material-icons">backup</span> Backup</h3>`;
  const content = document.createElement("div");
  content.className = "content";

  const dataStr = JSON.stringify(state, null, 2);
  content.innerHTML = `
    <p>Puoi scaricare il backup dei dati attuali in formato JSON.</p>
    <textarea readonly style="width:100%;height:180px;background:#222;color:#eee;padding:12px;border-radius:8px;resize:none; font-family: monospace;">${dataStr}</textarea>
  `;

  const btnExport = document.createElement("button");
  btnExport.className = "btn";
  btnExport.textContent = "Scarica backup JSON";
  btnExport.onclick = () => {
    const blob = new Blob([dataStr], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `smarthome-backup-${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
    localStorage.setItem('fabio_hub_backup_date', new Date().toLocaleString());
    render();
  };

  content.appendChild(btnExport);
  card.appendChild(content);
  v.appendChild(card);
}

/* ----- Settings ----- */
function renderSettings(v){
  v.innerHTML = "";
  const card = document.createElement("section");
  card.className = "card";
  card.innerHTML = `<h3><span class="material-icons">settings</span> Impostazioni</h3>`;
  const content = document.createElement("div");
  content.className = "content";

  content.innerHTML = `
    <label>
      Tema:
      <select id="themeSelect">
        <option value="dark" ${state.prefs.theme==="dark" ? "selected" : ""}>Scuro</option>
        <option value="light" ${state.prefs.theme==="light" ? "selected" : ""}>Chiaro</option>
      </select>
    </label>
  `;

  const themeSelect = $("#themeSelect");
  themeSelect.onchange = e => {
    state.prefs.theme = e.target.value;
    applyTheme();
    save();
  };

  card.appendChild(content);
  v.appendChild(card);
}

function applyTheme(){
  if(state.prefs.theme === "light"){
    document.documentElement.style.setProperty("--bg", "#f8f9fa");
    document.documentElement.style.setProperty("--bg-alt", "#e9ecef");
    document.documentElement.style.setProperty("--card-bg", "#ffffff");
    document.documentElement.style.setProperty("--txt-primary", "#212529");
    document.documentElement.style.setProperty("--txt-secondary", "#6c757d");
    document.documentElement.style.setProperty("--border", "#dee2e6");
    document.documentElement.style.setProperty("--shadow", "0 4px 12px rgba(0,0,0,0.1)");
  } else {
    document.documentElement.style.setProperty("--bg", "#121417");
    document.documentElement.style.setProperty("--bg-alt", "#1e222a");
    document.documentElement.style.setProperty("--card-bg", "#252a38");
    document.documentElement.style.setProperty("--txt-primary", "#e8ecf1");
    document.documentElement.style.setProperty("--txt-secondary", "#8a94a7");
    document.documentElement.style.setProperty("--border", "#303752");
    document.documentElement.style.setProperty("--shadow", "0 4px 12px rgba(0, 0, 0, 0.5)");
  }
}

window.addEventListener("hashchange", render);

document.addEventListener("DOMContentLoaded", () => {
  applyTheme();
  render();
});
</script>
</body>
</html>
