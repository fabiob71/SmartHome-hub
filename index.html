<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SmartHome Hub – Fabio</title>
<link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'/>">
<style>
  :root{
    --bg:#0f1115; --panel:#161a22; --muted:#8a94a7; --txt:#e8ecf1;
    --acc:#6ae3ff; --acc2:#7bffb7; --red:#ff6b6b; --amber:#ffc857;
    --ok:#38d39f; --card:#1b2130; --border:#232a3a; --shadow:0 8px 28px rgba(0,0,0,.35)
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0c0f14 0%,#0f1115 100%);color:var(--txt);font:15px/1.45 system-ui, -apple-system, Segoe UI, Roboto}
  header{position:sticky;top:0;z-index:20;background:rgba(15,17,21,.7);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
  .bar{max-width:1100px;margin:auto;display:flex;align-items:center;gap:14px;padding:10px 16px}
  .logo{display:flex;align-items:center;gap:10px;font-weight:700}
  .logo i{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--acc),var(--acc2));display:inline-block}
  nav{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
  nav button{background:transparent;border:1px solid var(--border);color:var(--txt);padding:8px 10px;border-radius:10px;cursor:pointer}
  nav button.active, nav button:hover{border-color:var(--acc);box-shadow:0 0 0 2px rgba(106,227,255,.15)}
  main{max-width:1100px;margin:14px auto;padding:0 16px 50px}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
  .card{grid-column:span 12;background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
  .card>h3{margin:0;padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
  .card>div.content{padding:14px 16px}
  @media(min-width:900px){
    .col-4{grid-column:span 4}.col-6{grid-column:span 6}.col-8{grid-column:span 8}
  }
  .muted{color:var(--muted)}
  .pill{font-size:12px;border:1px solid var(--border);padding:4px 8px;border-radius:999px}
  .btn{background:linear-gradient(135deg,var(--acc),var(--acc2));border:0;color:#0b0e13;font-weight:700;padding:10px 12px;border-radius:12px;cursor:pointer}
  .btn.outline{background:transparent;border:1px solid var(--acc);color:var(--txt)}
  .list{display:flex;flex-direction:column;gap:10px}
  .row{display:flex;align-items:center;justify-content:space-between;gap:10px;background:rgba(255,255,255,.02);padding:10px;border-radius:12px;border:1px solid var(--border)}
  .row .meta{display:flex;align-items:center;gap:10px}
  .toggle{appearance:none;width:48px;height:28px;background:#394155;border-radius:999px;position:relative;cursor:pointer;outline:none;border:1px solid var(--border)}
  .toggle:checked{background:linear-gradient(135deg,var(--acc),var(--acc2))}
  .toggle:before{content:"";position:absolute;top:3px;left:3px;width:22px;height:22px;border-radius:50%;background:#fff;transition:.2s}
  .toggle:checked:before{transform:translateX(20px)}
  .fld{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0}
  .fld input,.fld select,.fld textarea{background:#11151f;border:1px solid var(--border);color:var(--txt);padding:10px;border-radius:10px;min-width:220px}
  .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;background:#0b0e13;border:1px solid var(--border);padding:2px 6px;border-radius:6px}
  .hint{font-size:12px;color:var(--muted)}
  /* floorplan */
  .plan-wrap{display:grid;grid-template-columns:1fr 320px;gap:12px}
  .canvas{background:#0b0e13;border:1px dashed #2a3246;border-radius:12px;position:relative;min-height:320px;overflow:hidden}
  .canvas img{width:100%;height:auto;display:block;opacity:.95}
  .pin{position:absolute;transform:translate(-50%,-100%);display:flex;flex-direction:column;align-items:center;gap:4px;cursor:grab}
  .pin i{width:16px;height:16px;border-radius:50%;background:linear-gradient(135deg,var(--amber),var(--acc));box-shadow:0 2px 10px rgba(0,0,0,.5)}
  .pin label{font-size:12px;background:#0b0e13;border:1px solid var(--border);padding:3px 6px;border-radius:6px}
  .pin.off i{filter:grayscale(1);opacity:.5}
  /* tables */
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:10px;text-align:left}
  tr:hover td{background:rgba(255,255,255,.02)}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="logo"><i></i> SmartHome Hub <span class="pill">MVP</span></div>
    <nav id="nav"></nav>
  </div>
</header>

<main id="view"></main>

<script>
/* ===========================
   SmartHome Hub – MVP Frontend
   - Stato locale in localStorage
   - Dispositivi manuali + "Scan" mock
   - Planimetria con pin trascinabili
   - Automazioni base (condizione/azione)
   - Backup/Restore JSON
   - Hook API pronti (Home Assistant / Alexa / backend)
   =========================== */

const TABS = [
  {id:"dash", label:"Dashboard"},
  {id:"devices", label:"Dispositivi"},
  {id:"floor", label:"Planimetria"},
  {id:"auto", label:"Automazioni"},
  {id:"backup", label:"Backup"},
  {id:"settings", label:"Impostazioni"},
];
const $ = (sel, el=document)=>el.querySelector(sel);
const $$= (sel, el=document)=>[...el.querySelectorAll(sel)];
const bus = new EventTarget();
const state = load() || {
  devices: [],        // {id,name,type,room,ip,connected,on,meta:{} , x,y}
  rooms: ["Ingresso","Salone","Cucina","Camera","Bagno"],
  floorplan: {src:"", pins:{}}, // by deviceId: {x,y}
  automations: [],    // {id,name,if:{deviceId,prop,op,value}, then:{deviceId,action}}
  prefs: {theme:"dark", units:"metric"},
  createdAt: Date.now()
};

function load(){ try{return JSON.parse(localStorage.getItem("fabio_hub_v1"))}catch(e){return null} }
function save(){ localStorage.setItem("fabio_hub_v1", JSON.stringify(state)); }

function uid(){ return Math.random().toString(36).slice(2,9); }
function setTab(id){ location.hash = id; render(); }
function activeTab(){ return location.hash?.slice(1) || "dash"; }

function renderNav(){
  const nav = $("#nav");
  nav.innerHTML = "";
  TABS.forEach(t=>{
    const b=document.createElement("button");
    b.textContent=t.label;
    b.className = activeTab()===t.id?"active":"";
    b.onclick=()=>setTab(t.id);
    nav.appendChild(b);
  });
}

/* ---------- VIEWS ---------- */

function render(){
  renderNav();
  const v = $("#view");
  v.innerHTML = "";
  switch(activeTab()){
    case "dash": renderDashboard(v); break;
    case "devices": renderDevices(v); break;
    case "floor": renderFloorplan(v); break;
    case "auto": renderAutomations(v); break;
    case "backup": renderBackup(v); break;
    case "settings": renderSettings(v); break;
    default: renderDashboard(v); break;
  }
}

/* -------- DASHBOARD -------- */
function renderDashboard(container){
  const card = document.createElement("section");
  card.className = "card";
  card.innerHTML = `
    <h3>Dashboard</h3>
    <div class="content">
      <p>Dispositivi totali: <strong>${state.devices.length}</strong></p>
      <p>Automazioni attive: <strong>${state.automations.length}</strong></p>
      <p>Ultimo salvataggio: <small>${new Date(state.createdAt).toLocaleString()}</small></p>
    </div>
  `;
  container.appendChild(card);
}

/* -------- DEVICES -------- */
function renderDevices(container){
  const card = document.createElement("section");
  card.className = "card";
  card.innerHTML = `<h3>Dispositivi</h3>`;
  
  const list = document.createElement("div");
  list.className = "list";
  
  // Lista dispositivi
  state.devices.forEach(d=>{
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <div class="meta">
        <strong>${d.name}</strong> - <em>${d.type}</em> in <em>${d.room}</em>
      </div>
      <label>
        <input type="checkbox" class="toggle" data-id="${d.id}" ${d.on?"checked":""}/>
      </label>
    `;
    list.appendChild(row);
  });
  
  card.appendChild(list);
  
  // Form aggiunta nuovo dispositivo
  const form = document.createElement("form");
  form.innerHTML = `
    <h4>Aggiungi dispositivo</h4>
    <div class="fld">
      <input type="text" name="name" placeholder="Nome" required/>
      <select name="type" required>
        <option value="" disabled selected>Tipo</option>
        <option value="Lampada">Lampada</option>
        <option value="Sensore">Sensore</option>
        <option value="Presenza">Sensore Presenza</option>
        <option value="Termostato">Termostato</option>
        <option value="Altoparlante">Altoparlante</option>
      </select>
      <select name="room" required>
        <option value="" disabled selected>Stanza</option>
        ${state.rooms.map(r=>`<option value="${r}">${r}</option>`).join("")}
      </select>
      <button class="btn" type="submit">Aggiungi</button>
    </div>
  `;
  form.onsubmit = e=>{
    e.preventDefault();
    const fd = new FormData(form);
    const device = {
      id: uid(),
      name: fd.get("name"),
      type: fd.get("type"),
      room: fd.get("room"),
      ip: "",
      connected: true,
      on: false,
      meta: {},
      x: null,
      y: null
    };
    state.devices.push(device);
    save();
    render();
  };
  card.appendChild(form);
  
  // Toggle on/off dispositivo
  list.querySelectorAll("input.toggle").forEach(input=>{
    input.onchange = e=>{
      const id = e.target.dataset.id;
      const d = state.devices.find(dev=>dev.id===id);
      if(d){
        d.on = e.target.checked;
        save();
        render();
      }
    };
  });
  
  container.appendChild(card);
}

/* -------- FLOORPLAN -------- */
function renderFloorplan(container){
  const card = document.createElement("section");
  card.className = "card plan-wrap";
  
  // Immagine planimetria
  const imgSrc = state.floorplan.src || "";
  
  card.innerHTML = `
    <h3>Planimetria</h3>
    <div class="canvas">
      ${imgSrc ? `<img src="${imgSrc}" alt="Planimetria"/>` : `<p class="muted">Carica un'immagine della planimetria per posizionare i dispositivi</p>`}
      ${state.devices.map(d=>{
        if(d.x != null && d.y != null){
          return `<div class="pin${d.on ? "" : " off"}" data-id="${d.id}" style="left:${d.x*100}%; top:${d.y*100}%">
            <i></i><label>${d.name}</label>
          </div>`;
        }
        return "";
      }).join("")}
    </div>
    <form id="uploadFloorplan" class="fld">
      <input type="file" accept="image/*"/>
      <button class="btn" type="submit">Carica Planimetria</button>
    </form>
    <p class="hint">Trascina i pin per posizionare i dispositivi.</p>
  `;

  container.appendChild(card);
  
  const canvas = container.querySelector(".canvas");
  const pins = canvas.querySelectorAll(".pin");
  
  // Drag & Drop pins
  pins.forEach(pin=>{
    pin.style.touchAction = "none";
    let dragging = false;
    let startX, startY;
    
    function onPointerDown(e){
      e.preventDefault();
      dragging = true;
      startX = e.clientX;
      startY = e.clientY;
      pin.setPointerCapture(e.pointerId);
    }
    function onPointerMove(e){
      if(!dragging) return;
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      let dx = e.clientX - startX;
      let dy = e.clientY - startY;
      startX = e.clientX;
      startY = e.clientY;
      
      let left = pin.offsetLeft + dx;
      let top = pin.offsetTop + dy;
      // clamp
      left = Math.min(rect.width, Math.max(0, left));
      top = Math.min(rect.height, Math.max(0, top));
      
      pin.style.left = left + "px";
      pin.style.top = top + "px";
    }
    function onPointerUp(e){
      if(!dragging) return;
      dragging = false;
      pin.releasePointerCapture(e.pointerId);
      const rect = canvas.getBoundingClientRect();
      const left = (pin.offsetLeft + pin.offsetWidth/2) / rect.width;
      const top = (pin.offsetTop + pin.offsetHeight) / rect.height;
      const id = pin.dataset.id;
      const dev = state.devices.find(d=>d.id === id);
      if(dev){
        dev.x = left;
        dev.y = top;
        save();
        render();
      }
    }
    
    pin.addEventListener("pointerdown", onPointerDown);
    pin.addEventListener("pointermove", onPointerMove);
    pin.addEventListener("pointerup", onPointerUp);
    pin.addEventListener("pointercancel", onPointerUp);
  });
  
  // Upload immagine planimetria
  const form = container.querySelector("#uploadFloorplan");
  form.onsubmit = e=>{
    e.preventDefault();
    const fileInput = form.querySelector("input[type=file]");
    if(fileInput.files.length){
      const file = fileInput.files[0];
      const reader = new FileReader();
      reader.onload = function(ev){
        state.floorplan.src = ev.target.result;
        save();
        render();
      };
      reader.readAsDataURL(file);
    }
  };
}

/* -------- AUTOMATIONS -------- */
function renderAutomations(container){
  const card = document.createElement("section");
  card.className = "card";
  card.innerHTML = `<h3>Automazioni</h3>`;
  
  const list = document.createElement("div");
  list.className = "list";
  
  state.automations.forEach(auto=>{
    const row = document.createElement("div");
    row.className = "row";
    const dIf = state.devices.find(d=>d.id===auto.if.deviceId);
    const dThen = state.devices.find(d=>d.id===auto.then.deviceId);
    row.innerHTML = `
      <div class="meta">
        <strong>${auto.name}</strong><br/>
        Se <em>${dIf ? dIf.name : "(dispositivo sconosciuto)"}</em> 
        <code>${auto.if.prop} ${auto.if.op} ${auto.if.value}</code> allora 
        <em>${dThen ? dThen.name : "(dispositivo sconosciuto)"}</em> fa <code>${auto.then.action}</code>
      </div>
      <button class="btn outline" data-id="${auto.id}">Elimina</button>
    `;
    list.appendChild(row);
  });
  
  card.appendChild(list);
  
  // Form aggiungi automazione
  const form = document.createElement("form");
  form.innerHTML = `
    <h4>Nuova Automazione</h4>
    <div class="fld">
      <input type="text" name="name" placeholder="Nome automazione" required/>
      <select name="deviceIf" required>
        <option value="" disabled selected>Dispositivo Condizione</option>
        ${state.devices.map(d=>`<option value="${d.id}">${d.name}</option>`).join("")}
      </select>
      <select name="prop" required>
        <option value="" disabled selected>Proprietà</option>
        <option value="on">On/Off</option>
        <option value="connected">Connesso</option>
      </select>
      <select name="op" required>
        <option value="" disabled selected>Operatore</option>
        <option value="==">==</option>
        <option value="!=">!=</option>
      </select>
      <select name="deviceThen" required>
        <option value="" disabled selected>Dispositivo Azione</option>
        ${state.devices.map(d=>`<option value="${d.id}">${d.name}</option>`).join("")}
      </select>
      <select name="action" required>
        <option value="" disabled selected>Azione</option>
        <option value="turn_on">Accendi</option>
        <option value="turn_off">Spegni</option>
      </select>
      <button class="btn" type="submit">Aggiungi</button>
    </div>
  `;
  form.onsubmit = e=>{
    e.preventDefault();
    const fd = new FormData(form);
    const auto = {
      id: uid(),
      name: fd.get("name"),
      if: {
        deviceId: fd.get("deviceIf"),
        prop: fd.get("prop"),
        op: fd.get("op"),
        value: fd.get("op") === "==" ? true : false
      },
      then: {
        deviceId: fd.get("deviceThen"),
        action: fd.get("action")
      }
    };
    state.automations.push(auto);
    save();
    render();
  };
  card.appendChild(form);
  
  // Elimina automazioni
  list.querySelectorAll("button").forEach(btn=>{
    btn.onclick = e=>{
      const id = btn.dataset.id;
      state.automations = state.automations.filter(a=>a.id !== id);
      save();
      render();
    };
  });
  
  container.appendChild(card);
}

/* -------- BACKUP -------- */
function renderBackup(container){
  const card = document.createElement("section");
  card.className = "card";
  card.innerHTML = `<h3>Backup & Restore</h3>`;
  
  // Export JSON
  const exportBtn = document.createElement("button");
  exportBtn.className = "btn";
  exportBtn.textContent = "Esporta Backup";
  exportBtn.onclick = ()=>{
    const dataStr = JSON.stringify(state, null, 2);
    const blob = new Blob([dataStr], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `smarthomehub-backup-${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);
  };
  card.appendChild(exportBtn);
  
  // Import JSON
  const form = document.createElement("form");
  form.innerHTML = `
    <h4>Importa Backup</h4>
    <input type="file" accept="application/json" required/>
    <button class="btn" type="submit">Importa</button>
  `;
  form.onsubmit = e=>{
    e.preventDefault();
    const fileInput = form.querySelector("input[type=file]");
    if(fileInput.files.length){
      const file = fileInput.files[0];
      const reader = new FileReader();
      reader.onload = function(ev){
        try{
          const imported = JSON.parse(ev.target.result);
          if(imported.devices && imported.rooms){
            Object.assign(state, imported);
            save();
            alert("Backup importato con successo!");
            render();
          }else{
            alert("Backup non valido.");
          }
        }catch{
          alert("Errore durante l'importazione.");
        }
      };
      reader.readAsText(file);
    }
  };
  card.appendChild(form);
  container.appendChild(card);
}

/* -------- SETTINGS -------- */
function renderSettings(container){
  const card = document.createElement("section");
  card.className = "card";
  card.innerHTML = `<h3>Impostazioni</h3>`;
  
  const form = document.createElement("form");
  form.innerHTML = `
    <div class="fld">
      <label>Temi:
        <select name="theme">
          <option value="dark" ${state.prefs.theme==="dark"?"selected":""}>Scuro</option>
          <option value="light" ${state.prefs.theme==="light"?"selected":""}>Chiaro</option>
        </select>
      </label>
      <label>Unità di misura:
        <select name="units">
          <option value="metric" ${state.prefs.units==="metric"?"selected":""}>Metrico</option>
          <option value="imperial" ${state.prefs.units==="imperial"?"selected":""}>Imperiale</option>
        </select>
      </label>
      <button class="btn" type="submit">Salva Impostazioni</button>
    </div>
  `;
  form.onsubmit = e=>{
    e.preventDefault();
    const fd = new FormData(form);
    state.prefs.theme = fd.get("theme");
    state.prefs.units = fd.get("units");
    save();
    alert("Impostazioni salvate!");
    render();
  };
  card.appendChild(form);
  container.appendChild(card);
}

/* ---------- INIT ---------- */
window.addEventListener("hashchange", render);
render();

</script>
</body>
</html>
