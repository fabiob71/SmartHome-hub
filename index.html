<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SmartHome Hub – UI Rinnovata</title>
  <!-- Font & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" rel="stylesheet" />
  <style>
    :root {
      --bg: #0b0f14;
      --bg-elev: #111824;
      --card: #121b2a;
      --muted: #8fa1b6;
      --text: #e9f0f7;
      --border: #1e2a3c;
      --accent: #6ae3ff;
      --accent-2: #7bffb7;
      --danger: #ff6b6b;
      --warning: #ffc857;
      --success: #38d39f;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --radius-lg: 26px;
      --trans: .22s cubic-bezier(.2,.6,.2,1);
    }
    * { box-sizing: border-box }
    html, body { height: 100% }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      color: var(--text);
      background: radial-gradient(1200px 700px at 70% -10%, #162136 0%, transparent 60%) , var(--bg);
    }

    /* Header */
    header {
      position: sticky; top: 0; z-index: 50;
      backdrop-filter: saturate(1.2) blur(10px);
      background: linear-gradient(180deg, rgba(17,24,36,.75), rgba(17,24,36,.55));
      border-bottom: 1px solid var(--border);
    }
    .bar { max-width: 1100px; margin: 0 auto; display: flex; align-items: center; gap: 14px; padding: 14px 16px; }
    .logo { display: flex; align-items: center; gap: 10px; font-weight: 700; letter-spacing: .2px; }
    .logo i { font-variation-settings: 'FILL' 1; font-size: 28px; color: var(--accent); }
    .logo .badge { background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: #00161f; font-weight: 700; padding: 2px 10px; border-radius: 999px; font-size: 12px; }

    /* Tabs */
    .tabs { margin-left: auto; display: flex; gap: 6px; background: var(--bg-elev); padding: 6px; border-radius: 999px; border: 1px solid var(--border); }
    .tab { border: 0; background: transparent; color: var(--muted); font-weight: 600; padding: 10px 14px; border-radius: 999px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: var(--trans); }
    .tab i { font-size: 20px; }
    .tab:hover { color: var(--text); }
    .tab.active { background: linear-gradient(135deg, rgba(106,227,255,.18), rgba(123,255,183,.18)); color: var(--text); box-shadow: inset 0 0 0 1px rgba(122,223,210,.3); }

    main { max-width: 1100px; margin: 22px auto 40px; padding: 0 16px; }

    /* Cards & layout */
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 18px; }
    .card { background: linear-gradient(180deg, rgba(18,27,42,1), rgba(18,27,42,.9)); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; }
    .card h3 { margin: 0; padding: 16px 18px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; font-size: 1.05rem; }
    .card h3 i { color: var(--accent); font-size: 22px; }
    .content { padding: 16px 18px; display: flex; flex-direction: column; gap: 12px; }

    .muted { color: var(--muted); }
    .pill { font-size: 12px; border: 1px solid var(--border); padding: 4px 10px; border-radius: 999px; color: var(--muted); background: rgba(255,255,255,.03); }

    /* Buttons */
    .btn { border: 0; cursor: pointer; font-weight: 700; padding: 10px 14px; border-radius: 12px; transition: var(--trans); display: inline-flex; align-items: center; gap: 8px; }
    .btn.primary { background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: #04131b; }
    .btn.primary:hover { transform: translateY(-1px); filter: saturate(1.1); }
    .btn.ghost { background: transparent; border: 1px solid var(--border); color: var(--text); }
    .btn.ghost:hover { background: rgba(255,255,255,.05); }
    .btn.icon { padding: 8px; border-radius: 10px; background: rgba(255,255,255,.06); border: 1px solid var(--border); }

    /* Toggles */
    .toggle { appearance: none; width: 48px; height: 28px; border-radius: 999px; background: #2a3951; position: relative; border: 1px solid var(--border); transition: var(--trans); cursor: pointer; }
    .toggle:before { content: ""; position: absolute; top: 3px; left: 3px; width: 22px; height: 22px; border-radius: 50%; background: #fff; box-shadow: 0 5px 18px rgba(0,0,0,.25); transition: var(--trans); }
    .toggle:checked { background: linear-gradient(135deg, var(--accent), var(--accent-2)); }
    .toggle:checked:before { transform: translateX(20px); }

    /* Lists */
    .list { display: flex; flex-direction: column; gap: 12px; }
    .row { display: flex; align-items: center; justify-content: space-between; gap: 12px; background: rgba(255,255,255,.03); border: 1px solid var(--border); border-radius: 14px; padding: 12px 14px; transition: var(--trans); }
    .row:hover { background: rgba(255,255,255,.05); }
    .row .meta { display: flex; align-items: center; gap: 10px; }
    .row .actions { display: flex; gap: 8px; }

    /* Inputs */
    .field { display: flex; flex-direction: column; gap: 8px; }
    .field label { font-size: 13px; color: var(--muted); }
    .input, select, textarea { background: rgba(255,255,255,.04); color: var(--text); border: 1px solid var(--border); border-radius: 12px; padding: 10px 12px; outline: none; transition: var(--trans); }
    .input:focus, select:focus, textarea:focus { box-shadow: 0 0 0 2px rgba(106,227,255,.25); }

    /* Modal */
    .modal-backdrop { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.45); z-index: 100; }
    .modal { width: min(520px, 92vw); background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-lg); box-shadow: var(--shadow); }
    .modal .head { display: flex; align-items: center; justify-content: space-between; padding: 16px 18px; border-bottom: 1px solid var(--border); }
    .modal .body { padding: 16px 18px; display: flex; flex-direction: column; gap: 12px; }
    .modal .foot { padding: 16px 18px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; }

    /* Floorplan */
    .plan-wrap { display: grid; grid-template-columns: 1fr; gap: 12px; }
    .canvas { position: relative; min-height: 320px; background: #0e141e; border: 2px dashed var(--border); border-radius: var(--radius); overflow: hidden; }
    .canvas img { width: 100%; height: auto; display: block; opacity: .95; pointer-events: none; user-select: none; }
    .pin { position: absolute; transform: translate(-50%, -100%); display: flex; flex-direction: column; align-items: center; gap: 6px; cursor: grab; user-select: none; }
    .pin i { width: 18px; height: 18px; border-radius: 50%; background: linear-gradient(135deg, var(--warning), var(--accent)); box-shadow: 0 6px 22px rgba(0,0,0,.45); display: inline-block; }
    .pin label { font-size: 12px; background: rgba(0,0,0,.45); border: 1px solid var(--border); padding: 4px 8px; border-radius: 8px; white-space: nowrap; }
    .pin.off i { filter: grayscale(1); opacity: .55; }

    /* Toast */
    .toast { position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%) translateY(20px); background: #0f1724; border: 1px solid var(--border); color: var(--text); padding: 12px 16px; border-radius: 12px; opacity: 0; transition: var(--trans); z-index: 90; }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    /* Light theme */
    .light { --bg: #f6f8fb; --bg-elev:#ffffffd9; --card:#fff; --text:#0f172a; --muted:#586a85; --border:#e6eaf0; --shadow: 0 12px 28px rgba(16,24,40,.08); }

    @media (max-width: 680px){ .logo span.title { display:none } }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="logo">
        <i class="material-symbols-rounded">home</i>
        <span class="title">SmartHome Hub</span>
        <span class="badge">RINNOVATO</span>
      </div>
      <div class="tabs" id="tabs"></div>
    </div>
  </header>

  <main id="view"></main>

  <!-- Toast -->
  <div class="toast" id="toast">Salvato</div>

  <!-- Modal generic -->
  <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="head">
        <strong id="modalTitle">Titolo</strong>
        <button class="btn icon" id="modalClose" aria-label="Chiudi"><i class="material-symbols-rounded">close</i></button>
      </div>
      <div class="body" id="modalBody"></div>
      <div class="foot" id="modalFoot"></div>
    </div>
  </div>

  <script>
  // ======= Utilities =======
  const $ = (s, el=document) => el.querySelector(s);
  const $$ = (s, el=document) => [...el.querySelectorAll(s)];
  const bus = new EventTarget();
  const KEY = 'smarthub_v3';

  function uid(){ return Math.random().toString(36).slice(2, 9); }
  function load(){ try { return JSON.parse(localStorage.getItem(KEY)); } catch(e){ return null; } }
  function save(){ localStorage.setItem(KEY, JSON.stringify(state)); toast('Salvato'); }
  function toast(msg){ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1200); }

  const state = load() || {
    devices: [], // {id,name,type,room,on,meta:{},x,y}
    rooms: ['Ingresso','Salone','Cucina','Camera','Bagno'],
    floorplan: { src: '', pins: {} },
    automations: [], // {id,name,if:{deviceId,prop,op,value}, then:{deviceId,action}}
    prefs: { theme: 'dark', units: 'metric' },
    createdAt: Date.now()
  };

  // ======= Tabs =======
  const TABS = [
    { id:'dash', label:'Dashboard', icon:'dashboard' },
    { id:'devices', label:'Dispositivi', icon:'devices' },
    { id:'floor', label:'Planimetria', icon:'map' },
    { id:'auto', label:'Automazioni', icon:'settings_remote' },
    { id:'backup', label:'Backup', icon:'backup' },
    { id:'settings', label:'Impostazioni', icon:'settings' },
  ];

  function setTab(id){ location.hash = id; render(); }
  function activeTab(){ return location.hash?.slice(1) || 'dash'; }
  function renderTabs(){
    const wrap = $('#tabs');
    wrap.innerHTML = '';
    TABS.forEach(t => {
      const b = document.createElement('button');
      b.className = 'tab' + (activeTab()===t.id ? ' active' : '');
      b.innerHTML = `<i class="material-symbols-rounded">${t.icon}</i><span>${t.label}</span>`;
      b.onclick = () => setTab(t.id);
      wrap.appendChild(b);
    });
  }

  // ======= Modal =======
  function openModal(title, bodyEl, footEls=[]) {
    $('#modalTitle').textContent = title;
    const body = $('#modalBody'); body.innerHTML = ''; body.appendChild(bodyEl);
    const foot = $('#modalFoot'); foot.innerHTML = ''; footEls.forEach(el=>foot.appendChild(el));
    const bd = $('#modalBackdrop'); bd.style.display = 'flex'; bd.setAttribute('aria-hidden','false');
  }
  function closeModal(){ const bd = $('#modalBackdrop'); bd.style.display='none'; bd.setAttribute('aria-hidden','true'); }
  $('#modalClose').onclick = closeModal; $('#modalBackdrop').addEventListener('click', (e)=>{ if(e.target.id==='modalBackdrop') closeModal(); });

  // ======= Views =======
  function render(){
    renderTabs();
    const v = $('#view');
    const tab = activeTab();
    if(tab==='dash') renderDashboard(v);
    else if(tab==='devices') renderDevices(v);
    else if(tab==='floor') renderFloorplan(v);
    else if(tab==='auto') renderAutomations(v);
    else if(tab==='backup') renderBackup(v);
    else if(tab==='settings') renderSettings(v);
  }

  // --- Dashboard ---
  function renderDashboard(v){
    v.innerHTML = '';
    const g = document.createElement('div'); g.className = 'grid';

    // Summary card
    const c1 = card('dashboard', 'Dashboard');
    const ct1 = c1.querySelector('.content');
    ct1.innerHTML = `
      <div class="list">
        <div class="row"><div class="meta"><i class="material-symbols-rounded">memory</i><div>Dispositivi</div></div><strong>${state.devices.length}</strong></div>
        <div class="row"><div class="meta"><i class="material-symbols-rounded">meeting_room</i><div>Stanze</div></div><strong>${state.rooms.length}</strong></div>
        <div class="row"><div class="meta"><i class="material-symbols-rounded">auto_awesome_motion</i><div>Automazioni</div></div><strong>${state.automations.length}</strong></div>
        <div class="row"><div class="meta"><i class="material-symbols-rounded">cloud_done</i><div>Ultimo backup</div></div><strong>${localStorage.getItem('sh_last_backup') || 'Mai'}</strong></div>
      </div>`;

    // Quick actions
    const c2 = card('bolt', 'Azioni rapide');
    const ct2 = c2.querySelector('.content');
    const a1 = btn('Aggiungi dispositivo','add'); a1.onclick = () => openAddDevice();
    const a2 = btn('Aggiungi automazione','add_task'); a2.onclick = () => openAddAutomation();
    const a3 = btn('Carica planimetria','upload'); a3.onclick = () => setTab('floor');
    ct2.append(a1,a2,a3);

    g.append(c1,c2);
    v.appendChild(g);
  }

  // --- Devices ---
  function renderDevices(v){
    v.innerHTML = '';
    const c = card('devices','Dispositivi');
    const ct = c.querySelector('.content');

    if(state.devices.length===0){
      const p = document.createElement('p'); p.className='muted'; p.textContent='Nessun dispositivo. Aggiungine uno con il pulsante qui sotto.'; ct.appendChild(p);
    } else {
      const list = document.createElement('div'); list.className='list';
      state.devices.forEach(d=>{
        const row = document.createElement('div'); row.className='row';
        const meta = document.createElement('div'); meta.className='meta';
        const icon = document.createElement('i'); icon.className='material-symbols-rounded'; icon.textContent = pickIcon(d.type);
        const title = document.createElement('div'); title.innerHTML = `<strong>${escapeHTML(d.name)}</strong> <span class="pill">${escapeHTML(d.type)}</span> <span class="muted">${d.room||'—'}</span>`;
        meta.append(icon,title);
        const actions = document.createElement('div'); actions.className='actions';
        const tgl = document.createElement('input'); tgl.type='checkbox'; tgl.className='toggle'; tgl.checked = !!d.on; tgl.onchange = ()=>{ d.on = tgl.checked; save(); updatePins(); };
        const editB = iconBtn('edit'); editB.title='Modifica'; editB.onclick=()=> openEditDevice(d);
        const delB = iconBtn('delete'); delB.title='Elimina'; delB.onclick=()=> deleteDevice(d.id);
        actions.append(tgl, editB, delB);
        row.append(meta, actions); list.appendChild(row);
      });
      ct.appendChild(list);
    }

    const add = btn('Aggiungi dispositivo','add'); add.onclick = ()=> openAddDevice();
    ct.appendChild(add);
    $('#view').appendChild(c);
  }

  function openAddDevice(){
    const wrap = document.createElement('div');
    wrap.innerHTML = `
      <div class="field"><label>Nome</label><input class="input" id="d_name" placeholder="Lampada Salone" /></div>
      <div class="field"><label>Tipo</label><input class="input" id="d_type" placeholder="lampada, sensore…" /></div>
      <div class="field"><label>Stanza</label>${roomSelect('d_room')}</div>
    `;
    const cancel = ghostBtn('Annulla'); cancel.onclick = closeModal;
    const ok = primaryBtn('Aggiungi'); ok.onclick = ()=>{
      const name = $('#d_name').value.trim(); if(!name) return toast('Inserisci un nome');
      const type = $('#d_type').value.trim() || 'generico';
      const room = $('#d_room').value;
      state.devices.push({ id: uid(), name, type, room, on:false, meta:{}, x:50, y:50 });
      save(); closeModal(); render();
    };
    openModal('Nuovo dispositivo', wrap, [cancel, ok]);
  }

  function openEditDevice(d){
    const wrap = document.createElement('div');
    wrap.innerHTML = `
      <div class="field"><label>Nome</label><input class="input" id="e_name" value="${escapeHTML(d.name)}" /></div>
      <div class="field"><label>Tipo</label><input class="input" id="e_type" value="${escapeHTML(d.type)}" /></div>
      <div class="field"><label>Stanza</label>${roomSelect('e_room', d.room)}</div>
    `;
    const del = ghostBtn('Elimina'); del.onclick = ()=>{ deleteDevice(d.id); closeModal(); };
    const cancel = ghostBtn('Annulla'); cancel.onclick = closeModal;
    const ok = primaryBtn('Salva'); ok.onclick = ()=>{
      d.name = $('#e_name').value.trim() || d.name;
      d.type = $('#e_type').value.trim() || d.type;
      d.room = $('#e_room').value;
      save(); closeModal(); render(); updatePins();
    };
    openModal('Modifica dispositivo', wrap, [del, cancel, ok]);
  }

  function deleteDevice(id){
    if(!confirm('Eliminare il dispositivo?')) return;
    const i = state.devices.findIndex(x=>x.id===id);
    if(i>-1) state.devices.splice(i,1);
    save(); render(); updatePins();
  }

  // --- Floorplan ---
  function renderFloorplan(v){
    v.innerHTML = '';
    const c = card('map','Planimetria');
    const ct = c.querySelector('.content');

    const wrapper = document.createElement('div'); wrapper.className='plan-wrap';
    const canvas = document.createElement('div'); canvas.className='canvas'; canvas.id='canvas';

    if(state.floorplan.src){
      const img = document.createElement('img'); img.src = state.floorplan.src; canvas.appendChild(img);
    } else {
      const empty = document.createElement('div'); empty.className='muted'; empty.style.padding='12px'; empty.textContent='Nessuna planimetria caricata.'; canvas.appendChild(empty);
    }

    // Add pins
    state.devices.forEach(d=>{
      if(state.floorplan.src){
        const pin = document.createElement('div'); pin.className = 'pin' + (d.on ? '' : ' off');
        pin.style.left = (d.x ?? 50) + '%';
        pin.style.top = (d.y ?? 50) + '%';
        pin.innerHTML = `<i></i><label>${escapeHTML(d.name)}</label>`;
        pin.title = d.name;

        pin.onpointerdown = e => {
          e.preventDefault();
          const rect = canvas.getBoundingClientRect();
          function move(ev){
            const x = ((ev.clientX - rect.left) / rect.width) * 100;
            const y = ((ev.clientY - rect.top) / rect.height) * 100;
            pin.style.left = Math.min(100, Math.max(0, x)) + '%';
            pin.style.top = Math.min(100, Math.max(0, y)) + '%';
          }
          function up(){
            document.removeEventListener('pointermove', move);
            document.removeEventListener('pointerup', up);
            d.x = parseFloat(pin.style.left);
            d.y = parseFloat(pin.style.top);
            save();
          }
          document.addEventListener('pointermove', move);
          document.addEventListener('pointerup', up);
        };
        canvas.appendChild(pin);
      }
    });

    wrapper.appendChild(canvas);

    const up = document.createElement('input'); up.type='file'; up.accept='image/*';
    up.onchange = e => {
      const file = e.target.files[0]; if(!file) return;
      const r = new FileReader(); r.onload = ev => { state.floorplan.src = ev.target.result; save(); render(); };
      r.readAsDataURL(file);
    };

    ct.append(wrapper, up);
    v.appendChild(c);
  }

  function updatePins(){ if(activeTab()==='floor') renderFloorplan($('#view')); }

  // --- Automations ---
  function renderAutomations(v){
    v.innerHTML = '';
    const c = card('settings_remote','Automazioni');
    const ct = c.querySelector('.content');

    if(state.automations.length===0){
      const p = document.createElement('p'); p.className='muted'; p.textContent='Nessuna automazione. Creane una con il pulsante qui sotto.'; ct.appendChild(p);
    } else {
      const list = document.createElement('div'); list.className='list';
      state.automations.forEach(a=>{
        const row = document.createElement('div'); row.className='row';
        const di = state.devices.find(d=>d.id===a.if.deviceId); const dt = state.devices.find(d=>d.then.deviceId===d?.id);
        row.innerHTML = `<div class="meta"><i class="material-symbols-rounded">auto_awesome_motion</i><div><strong>${escapeHTML(a.name)}</strong><div class="muted" style="font-size:12px">IF ${escapeHTML(di?.name||a.if.deviceId)} ${a.if.prop} ${a.if.op} ${a.if.value} → THEN ${escapeHTML((state.devices.find(d=>d.id===a.then.deviceId)?.name)||a.then.deviceId)} ${a.then.action}</div></div></div>`;
        const actions = document.createElement('div'); actions.className='actions';
        const del = iconBtn('delete'); del.title='Elimina'; del.onclick=()=>{ deleteAutomation(a.id); };
        actions.append(del); row.appendChild(actions); list.appendChild(row);
      });
      ct.appendChild(list);
    }

    const add = btn('Aggiungi automazione','add_task'); add.onclick=()=> openAddAutomation();
    ct.appendChild(add);
    v.appendChild(c);
  }

  function openAddAutomation(){
    if(state.devices.length<1){ toast('Prima aggiungi almeno un dispositivo'); return; }
    const wrap = document.createElement('div');
    wrap.innerHTML = `
      <div class="field"><label>Nome</label><input id="a_name" class="input" placeholder="Accendi luci ingresso al tramonto" /></div>
      <div class="field"><label>Trigger – dispositivo</label>${deviceSelect('a_if_dev')}</div>
      <div class="field"><label>Proprietà</label><input id="a_if_prop" class="input" placeholder="on" value="on" /></div>
      <div class="field"><label>Operatore</label>
        <select id="a_if_op">
          <option value== selected>==</option>
          <option value=!=>!=</option>
        </select>
      </div>
      <div class="field"><label>Valore</label><input id="a_if_val" class="input" placeholder="true | false | 23…" value="true" /></div>
      <hr style="border:none;border-top:1px solid var(--border)">
      <div class="field"><label>Azione – dispositivo</label>${deviceSelect('a_then_dev')}</div>
      <div class="field"><label>Azione</label><input id="a_then_act" class="input" placeholder="toggle | on | off" value="toggle" /></div>
    `;
    const cancel = ghostBtn('Annulla'); cancel.onclick=closeModal;
    const ok = primaryBtn('Crea'); ok.onclick=()=>{
      const name = $('#a_name').value.trim()||'Automazione';
      const a = {
        id: uid(),
        name,
        if: { deviceId: $('#a_if_dev').value, prop: $('#a_if_prop').value.trim()||'on', op: $('#a_if_op').value, value: $('#a_if_val').value.trim()||'true' },
        then: { deviceId: $('#a_then_dev').value, action: $('#a_then_act').value.trim()||'toggle' }
      };
      state.automations.push(a); save(); closeModal(); render();
    };
    openModal('Nuova automazione', wrap, [cancel, ok]);
  }

  function deleteAutomation(id){
    if(!confirm('Eliminare l\'automazione?')) return;
    const i = state.automations.findIndex(a=>a.id===id); if(i>-1) state.automations.splice(i,1);
    save(); render();
  }

  // --- Backup ---
  function renderBackup(v){
    v.innerHTML = '';
    const c = card('backup','Backup');
    const ct = c.querySelector('.content');
    const dataStr = JSON.stringify(state, null, 2);

    const ta = document.createElement('textarea'); ta.readOnly=true; ta.style.width='100%'; ta.style.height='220px'; ta.className='input'; ta.value=dataStr;
    const exp = btn('Scarica backup JSON','download'); exp.onclick=()=>{
      const blob = new Blob([dataStr], {type:'application/json'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download=`smarthub-backup-${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(url); localStorage.setItem('sh_last_backup', new Date().toLocaleString()); render();
    };

    const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
    const imp = btn('Importa backup','upload'); imp.onclick=()=> inp.click();
    inp.onchange = (e)=>{
      const f = e.target.files[0]; if(!f) return; const r = new FileReader(); r.onload = ev => { try { Object.assign(state, JSON.parse(ev.target.result)); save(); render(); } catch(e){ toast('Backup non valido'); } } ; r.readAsText(f);
    };

    ct.append(ta, exp, imp, inp);
    v.appendChild(c);
  }

  // --- Settings ---
  function renderSettings(v){
    v.innerHTML = '';
    const c = card('settings','Impostazioni');
    const ct = c.querySelector('.content');

    const f = document.createElement('div'); f.className='field';
    f.innerHTML = `<label>Tema</label><select id="themeSel"><option value="dark" ${state.prefs.theme==='dark'?'selected':''}>Scuro</option><option value="light" ${state.prefs.theme==='light'?'selected':''}>Chiaro</option></select>`;
    ct.appendChild(f);

    const btnRooms = ghostBtn('Modifica stanze'); btnRooms.onclick=()=> openRoomsEditor(); ct.appendChild(btnRooms);

    const sel = f.querySelector('select'); sel.onchange = (e)=>{ state.prefs.theme = e.target.value; applyTheme(); save(); };
    v.appendChild(c);
  }

  function openRoomsEditor(){
    const wrap = document.createElement('div');
    const list = document.createElement('div'); list.className='list';
    state.rooms.forEach((r,idx)=>{
      const row = document.createElement('div'); row.className='row';
      row.innerHTML = `<div class="meta"><i class="material-symbols-rounded">meeting_room</i><strong>${escapeHTML(r)}</strong></div>`;
      const actions = document.createElement('div'); actions.className='actions';
      const del = iconBtn('delete'); del.onclick=()=>{ state.rooms.splice(idx,1); save(); openRoomsEditor(); };
      actions.append(del); row.appendChild(actions); list.appendChild(row);
    });
    const addWrap = document.createElement('div'); addWrap.className='field'; addWrap.innerHTML = `<label>Nuova stanza</label><input id="room_new" class="input" placeholder="Studio" />`;
    wrap.append(list, addWrap);

    const cancel = ghostBtn('Chiudi'); cancel.onclick=closeModal;
    const ok = primaryBtn('Salva'); ok.onclick=()=>{ const val=$('#room_new').value.trim(); if(val) state.rooms.push(val); save(); closeModal(); render(); };
    openModal('Stanze', wrap, [cancel, ok]);
  }

  // ======= Helpers UI =======
  function card(icon, title){
    const c = document.createElement('section'); c.className='card';
    c.innerHTML = `<h3><i class="material-symbols-rounded">${icon}</i> ${title}</h3><div class="content"></div>`;
    return c;
  }
  function btn(label, icon){ const b=document.createElement('button'); b.className='btn primary'; b.innerHTML = `<i class="material-symbols-rounded">${icon}</i>${label}`; return b; }
  function ghostBtn(label){ const b=document.createElement('button'); b.className='btn ghost'; b.textContent=label; return b; }
  function iconBtn(icon){ const b=document.createElement('button'); b.className='btn icon'; b.innerHTML = `<i class="material-symbols-rounded">${icon}</i>`; return b; }
  function deviceSelect(id){ const s=document.createElement('select'); s.id=id; state.devices.forEach(d=>{ const o=document.createElement('option'); o.value=d.id; o.textContent=d.name; s.appendChild(o); }); return s.outerHTML; }
  function roomSelect(id, val=''){ const s=document.createElement('select'); s.id=id; const none=document.createElement('option'); none.value=''; none.textContent='—'; s.appendChild(none); state.rooms.forEach(r=>{ const o=document.createElement('option'); o.value=r; o.textContent=r; if(r===val) o.selected=true; s.appendChild(o); }); return s.outerHTML; }
  function pickIcon(type){ type=(type||'').toLowerCase(); if(type.includes('lamp')) return 'lightbulb'; if(type.includes('sens')) return 'sensors'; if(type.includes('clima')||type.includes('termo')||type.includes('ac')) return 'device_thermostat'; if(type.includes('presa')||type.includes('plug')) return 'power'; if(type.includes('porta')||type.includes('finestra')) return 'door_sensor'; return 'memory'; }
  function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

  // Theme
  function applyTheme(){ document.body.classList.toggle('light', state.prefs.theme==='light'); }

  window.addEventListener('hashchange', render);
  document.addEventListener('DOMContentLoaded', ()=>{ applyTheme(); render(); });
  </script>
</body>
</html>
